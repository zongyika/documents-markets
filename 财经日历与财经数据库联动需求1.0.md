# 财经日历与财经数据库联动需求 1.0

## 文档控制

### 修改历史

| 修改人 | 修改日期 | 修改描述 |
| :-: | :-: | :-- |
| MOUSE | 2017-12-21 | 初稿 |
| MOUSE | 2017-12-22 | 将 unit 和 currency 字段修改为 quantity 和 unit 字段 |
| MOUSE | 2018-01-08 | 确定 event 配置表里 uid 字段规则，统一日历和数据库国家代码 |
| MOUSE | 2018-01-12 | 财经数据库 unit 字段不再做分拆，根据规则判断 BBG 单位，并调整数据后落库 |

### 审核记录

| 审核人 | 审核日期 | 角色 | 说明 |
| :-: | :-: | :-: | :-: |


## 1. 需求概述

### 1.1 目标

1. 财经日历数据落库逻辑和处理的修正，以适应数据的标准化入库和提取需求。
2. 财经数据库的字段和数据处理逻辑调整，以符合 BBG 订阅数据的落库条件。

### 1.2 功能清单

| 优先级 | 功能描述 |
| :-: | :-- |
| P0 | 财经日历 - event 配置表 |
| P0 | 财经日历 - 数据标准化落库 |
| P0 | 财经日历 - BBG 订阅数据推送 |
| P0 | 财经数据库 - BBG 订阅数据接口 |
| P0 | 统一财经日历和财经数据库的国家代码 |
| P0 | 财经数据库 - 增加『国家一览』字段 |
| P1 | 财经日历 - 数据初、终值逻辑完善 |
| P1 | 财经日历 - 数据单位变动逻辑调整 |

### 1.3 项目计划

| 项目阶段 | 预期时间 | 备注 |
| :-: | :-: | :-: |
| 开发 | | |
| 测试 | | |
| 上线 | | |

## 2. 流程

### 2.1
### 2.2

## 3. 功能设计

### 3.1 财经日历 - event 配置表

建立 event 配置表，字段包含：

1. `uid`：经济数据(FD)分类下，针对事件的唯一标识，**字段的值为财经数据库的指标码字段的值**
2. `country_id`：国家代码，如 "us"
3. `country_name`：国家中文名称，如 "美国"
4. `event`：事件中文名称，如 "ADP就业人数变动"
5. `quantity`：数量级别，如 "k"，"m"，"b" ，"t"
6. `unit`：单位，如 "亿美元"，"万桶"，"万人"，"%"
7. `ticker`：BBG 的 Ticker，如"ADP CHNG Index"

完整的 event 配置表数据，通过附件提供

### 3.2 财经日历 - 数据标准化落库

1. 编辑的 excel 导入，通过 `ticker` 字段对应 event 配置表，提取相关字段；

2. 解析日期字段，并以日期格式落库`curObversionDate`字段，规则如下：
	- 日，以显示日期落库，如 "2017-01-25"，
	- 月，转换月份后，以该月1日的时间落库，如 "Dec"，转换成："2017-12-01"
	- 季，转换季度后，以该季度第1个月的1日的时间落库，如 "4Q"，转换成："2017-10-01"
	- 年，以该年1月1日的时间落库，如"2017"，转换成："2017-01-01"

3. survey、actual、prior、revised，4个字段剔除单位，直接落库数值

### 3.3 财经日历 - BBG 订阅数据推送

1. BBG 订阅数据下发后落库，同时向财经数据库接口推送数据，必须至少含`ticker`、`curObversionDate`、`quantity`、`actual`、`survey`四个字段的值

### 3.4  财经数据库 - BBG 订阅数据接口

1. 接收到财经日历接口推送的数据后，对应 BBG Ticker，若数据库有对应的指标，则取用`curObversionDate`（数据日期）、`actual`（实际值）、`survey`（预测值） 3个字段新增一条数据

2. 由于 BBG 落库数据的单位和 CEIC 落库数据的单位可能存在差异，需要在新增数据前，判断 `quantity` 字段并匹配数据，若两边字段值不一致，需根据财经数据库的 `unit` 来调整数据值，相关性规则如下：
	- k（千）、m（百万）、b（十亿）、t（万亿），之间每个级别为前一个级别的1000倍
	- 若出现 BBG 为 "b"，CEIC 为 "m"，则接口推送过来的数据，乘以 1000 后落库；反之，除以 1000 后落库

### 3.5 统一财经日历和财经数据库的国家代码

见附件：country 配置表

### 3.6 指标配置增加字段，判断是否进『国家一览』页面

1. 增加`country_flag`字段；
2. 字段值为0：不进国家一览；
3. 字段值为1：进国家一览；
4. 默认为0

### 3.7  财经日历 - 数据初、终值逻辑完善

1. 如果日期字段为月份，则：
	- A、P 为『初值』，F 为『终值』

2. 如果日期字段为季度，则：
- A 为『初值』、P、S 为『修正值』、F 为『终值』

**P.S. 之前的判断没有分开考虑月度和季度。**

### 3.8 财经日历 - 数据单位变动逻辑调整

1. 所有 T，直接使用值
2. 所有 B，值×10，转换为「亿」
3. 所有 K，值÷10，转换为「万」
4. M，根据 event 配置表的`unit` 字段判断：
	- 「万」，则值×100
	- 「亿」，则值÷100

**P.S. 之前的判断由于部分数据单位动态调整，在数据出现极端值的时候，会造成数据序列单位不统一**
